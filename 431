import http.client
from markapi.puls.models import RequestLog
from markapi.warehouse.models import WarehouseProductStore
import time
import json
import xml.etree.ElementTree as ET  # Вытянуть все значения тега(ошибочные gtins) `<object_id>` из XML-документа


def unit_unpack(pack3_id, branch_id='00000000183005'):
    """
    "POST"
    Распаковываем из sscc
    pack3_id - из таблицы warehouse_warehouseproductstore
    branch_id - из таблицы warehouse_warehouseproductstore по умолчанию МSK
    return - ответ reqvest_id, при успехе
    """
    payload = "{\n  \"subject_id\": \"" + branch_id + "\",  \n  \"sscc\": \"" + pack3_id + "\",\n  \"is_recursive\": false\n}"
    conn = http.client.HTTPConnection("markirovka.puls.ru")
    headers = {
        'Authorization': "token c7c084a1fa3d7b611fa62eab4ce32c4ebeb86289",
        'Content-Type': "application/json",
        'X-BRANCH-ID': branch_id,
        'X-DB-PATH': "Srvr='CORPORATION';Ref='EIS_MSK';"
    }
    conn.request("POST", "/api/warehouse/v1.0/unit_unpack/", payload, headers)
    res = conn.getresponse()
    data = res.read()
    print(f"Сформирован новый 912 {data.decode('utf-8')} sscc - {pack3_id}")
    return json.loads(data.decode('utf-8'))


def accept_431(order, branch_id='00000000183005'):
    """
    "POST"
    Акцептует 431 реквест
    order - order от ошибочного 431
    """
    str_order = f"/api/warehouse/v1.0/order/{order}/"
    conn = http.client.HTTPConnection("markirovka.puls.ru")
    payload = "{\r\n\"status\": \"accept\"\r\n}"
    headers = {
        'Authorization': "token c7c084a1fa3d7b611fa62eab4ce32c4ebeb18023",
        'Content-Type': "application/json",
        'X-BRANCH-ID': "00000000183005",
        'X-DB-PATH': "Srvr='CORPORATION';Ref='EIS_MSK';"
    }
    conn.request("POST", str_order, payload, headers)
    res = conn.getresponse()
    data = res.read()
    print(f"Сформирован новый 431 {data.decode('utf-8')}\n")
    # return json.loads(data.decode('utf-8'))


def cheсk_912(request_id):
    """
    Проверка 912 который распаковывается.
    request_id - 912
    Возврашает True/False в завсемости от завершения 912
    """
    document = RequestLog.objects.get(request_id=request_id)
    while document:
        time.sleep(10)
        document = RequestLog.objects.get(request_id=request_id)
        if document.status == 'done':
            print(f"request_id: {document.request_id} action_id: {document.action_id} завершился успешно.")
            return True
        elif document.status == 'failed':
            print(f"request_id: {document.request_id} action_id: {document.action_id} завершился с ошибкой.")
            return False
        else:
            print(f"912 - {document.request_id} в обработке stage = {document.stage}")


def cheсk_unpack(sgtin, branch_id='00000000183005'):
    """
    Проверяем распаковку sscc
    sgtin - принимает sgtin
    return - sscc | sgtin | error
    """
    try:
        doc = WarehouseProductStore.objects.get(sgtin=sgtin, branch_id=branch_id)
        if doc.pack3_id:
            print(f"sgtin - {doc.sgtin} не распакован.")
            return ['pack3_id', doc.pack3_id]
        elif doc.sgtin:
            print(f"sgtin - {doc.sgtin} уже распакован.")
            return ['sgtin', doc.sgtin]
    except:
        print(f"sgtin - {sgtin} не найден на остатках")
        return ['error', sgtin]


docs = [
    '0c388415-6be1-4f97-a2ec-23e171f8df3d'
]  # request_id ошибочного 431

for doc in docs:
    print(f"В работе 431 request_id : {doc}")
    document = RequestLog.objects.get(request_id=doc)
    root = ET.fromstring(document.result_content)  # Создаем объект ElementTree из XML-строки

    pack3_id_set = set()  # Складываем все не распакованые SSCC
    gtins_set = set()  # Складываем все gtin
    error_pack3_id_set = set()  # Складываем все отсутствующие  в БД gtin

    # Ищем все теги object_id и их значение
    for object_id in root.findall(".//errors[error_code='15']/object_id"):  # Выбираем все sgtin с ошибкой 15
        # Проверяем распаковку
        result = cheсk_unpack(object_id.text)  # Чекаем состояние gtin
        match result:
            case 'pack3_id', arg:
                pack3_id_set.add(arg)
                gtins_set.add(object_id)
            case 'sgtin', arg:
                gtins_set.add(arg)
            case 'error', arg:
                error_pack3_id_set.add(arg)

    # Распаковываем gtins
    error_pack3_id_unit_unpack_tuple = ()  # Храним gtins с неудачной распаковкой
    for pack3_id in pack3_id_set:
        curl_request_id_912 = unit_unpack(pack3_id)  # Расспаковываем sscc

        if not cheсk_912(curl_request_id_912['request_id']):  # Проверка на ошибку распаковки.
            error_pack3_id_unit_unpack_tuple = (pack3_id,)

    # Переотправка 431
    if not error_pack3_id_unit_unpack_tuple and gtins_set and not error_pack3_id_set:  # Если ошибочных нет и gtins_set есть хотя бы одна запись то переотправляем 431
        accept_431(document.order_guid)
    else:
        print(f"431 Не переотправлен {document.order_guid}\n")
